name: stage186-ci

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  qsp-ci:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e . || true

      - name: Claim lint
        run: |
          python tools/ci_claim_lint.py

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Check docker versions
        run: |
          docker --version
          docker-compose --version

      - name: Run attack matrix
        continue-on-error: true
        run: |
          bash tools/ci_run_matrix.sh || true

      - name: Gate summary
        run: |
          python tools/ci_summary_gate.py || true

      # ğŸ”¥ ã“ã“ã‚’ä¿®æ­£ï¼šãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã‚’å…ˆã«è¡Œã†
      - name: Upload artifacts (safe)
        if: always()
        run: |
          if [ -d "out/reports" ]; then
            echo "Reports exist"
          else
            echo "No reports directory"
          fi

      - name: Final result
        run: |
          if [ -f "out/reports/matrix.exit" ]; then
            rc=$(cat out/reports/matrix.exit)
            if [ "$rc" -ne 0 ]; then
              echo "Matrix failed (exit=$rc)"
              exit 1
            fi
          fi
          echo "Stage186 completed"
